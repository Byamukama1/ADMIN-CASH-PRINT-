<!DOCTYPE html>  
<html lang="en">  
<head>  
  <meta charset="UTF-8" />  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />  
  <title>Earnings Manager - CashPrint</title>  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />  
  <style>  
    body {  
      font-family: 'Segoe UI', sans-serif;  
      background: #f4f6f8;  
      margin: 0;  
      padding: 20px;  
      color: #333;  
    }  
  
    .header {  
      display: flex;  
      flex-direction: column;  
      gap: 10px;  
      margin-bottom: 20px;  
    }  
  
    .header-bar {  
      display: flex;  
      justify-content: space-between;  
      align-items: center;  
    }  
  
    .btn {  
      padding: 10px 20px;  
      background-color: #007B55;  
      color: white;  
      border: none;  
      border-radius: 6px;  
      cursor: pointer;  
      font-size: 16px;  
    }  
  
    .btn:hover {  
      background-color: #00563a;  
    }  
  
    .search-input {  
      padding: 8px 14px;  
      width: 100%;  
      max-width: 300px;  
      border: 1px solid #ccc;  
      border-radius: 6px;  
      font-size: 16px;  
    }  
  
    .card {  
      background: white;  
      padding: 15px;  
      margin-bottom: 12px;  
      border-radius: 8px;  
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);  
    }  
  
    .card p {  
      margin: 6px 0;  
    }  
  </style>  
</head>  
<body>  
  <div class="header">  
    <div class="header-bar">  
      <h2>ðŸ“ˆ Earnings Manager</h2>  
      <button class="btn" id="processEarningsBtn">Process Earnings</button>  
    </div>  
    <input type="text" id="searchInput" class="search-input" placeholder="Search by name or phone...">  
  </div>  
  
  <div id="earningsContainer">Loading earnings...</div>  
  
  <script>  
    const firebaseConfig = {  
      apiKey: "AIzaSyDIP5I-yG0skjsva9B3p-pMshPuq4odFU8",  
      authDomain: "cashprint-c5e72.firebaseapp.com",  
      projectId: "cashprint-c5e72",  
      storageBucket: "cashprint-c5e72.appspot.com",  
      messagingSenderId: "613734624925",  
      appId: "1:613734624925:web:d6bc8a18b3b6cb3a31ae74"  
    };  
  
    firebase.initializeApp(firebaseConfig);  
    const db = firebase.firestore();  
  
    const earningsContainer = document.getElementById('earningsContainer');  
    const processBtn = document.getElementById('processEarningsBtn');  
    const searchInput = document.getElementById('searchInput');  
    const lastProcessedTimeKey = "lastProcessedTime";  
  
    let allEarnings = [];  
  
    async function loadEarnings() {  
      earningsContainer.innerHTML = 'Loading...';  
      allEarnings = [];  
  
      const snapshot = await db.collection("earnings").get();  
  
      for (const doc of snapshot.docs) {  
        const data = doc.data();  
        const userId = data.userId;  
        const docId = doc.id;  
  
        try {  
          const userDoc = await db.collection("users").doc(userId).get();  
          const userData = userDoc.exists ? userDoc.data() : {};  
  
          allEarnings.push({  
            docId,  
            userId,  
            name: userData.name || 'Unknown',  
            phone: userData.phone || 'N/A',  
            ...data  
          });  
        } catch (error) {  
          console.error("Error fetching user data:", error);  
        }  
      }  
  
      renderEarnings(allEarnings);  
    }  
  
    function renderEarnings(dataList) {  
      earningsContainer.innerHTML = '';  
      if (dataList.length === 0) {  
        earningsContainer.innerHTML = '<p>No earnings found.</p>';  
        return;  
      }  
  
      dataList.forEach(entry => {  
        const card = document.createElement('div');  
        card.className = 'card';  
        card.innerHTML = `  
          <p><b>Name:</b> ${entry.name}</p>  
          <p><b>Phone:</b> ${entry.phone}</p>  
          <p><b>Amount:</b> ${entry.amount}</p>  
          <p><b>Daily Income:</b> ${entry.dailyIncome}</p>  
          <p><b>Remaining Days:</b> ${entry.remainingDays}</p>  
          <p><b>Date:</b> ${new Date(entry.timestamp?.seconds * 1000).toLocaleString()}</p>  
        `;  
        earningsContainer.appendChild(card);  
      });  
    }  
  
    // âœ… Updated processing logic â€” updates both earnings docs and user balances  
    async function processEarnings() {  
      const last = localStorage.getItem(lastProcessedTimeKey);  
      const now = Date.now();  
  
      if (last && now - last < 86400000) {  
        const remaining = Math.ceil((86400000 - (now - last)) / 3600000);  
        alert(`You can process earnings again in ${remaining} hour(s)`);  
        return;  
      }  
  
      const snapshot = await db.collection("earnings").get();  
  
      for (const doc of snapshot.docs) {  
        const data = doc.data();  
        const earningRef = db.collection("earnings").doc(doc.id);  
  
        if (data.remainingDays > 0) {  
          const newRemaining = data.remainingDays - 1;  
          const newTotalEarned = (data.totalEarnedSoFar || 0) + (data.dailyIncome || 0);  
  
          // Update earnings document  
          await earningRef.update({  
            remainingDays: newRemaining,  
            totalEarnedSoFar: newTotalEarned  
          });  
  
          // Update user account balance  
          await db.collection("users").doc(data.userId).update({  
            accountBalance: firebase.firestore.FieldValue.increment(data.dailyIncome)  
          });  
        } else {  
          // Mark earning as completed  
          await earningRef.update({ status: "completed" });  
        }  
      }  
  
      alert("âœ… Earnings processed successfully and balances updated");  
      localStorage.setItem(lastProcessedTimeKey, now);  
      loadEarnings();  
    }  
  
    searchInput.addEventListener("input", () => {  
      const keyword = searchInput.value.toLowerCase();  
      const filtered = allEarnings.filter(entry =>  
        entry.name.toLowerCase().includes(keyword) ||  
        entry.phone.toLowerCase().includes(keyword)  
      );  
      renderEarnings(filtered);  
    });  
  
    processBtn.addEventListener("click", processEarnings);  
    loadEarnings();  
  </script>  
</body>  
</html>