<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - CashPrint</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f3f4f6;
      padding: 20px;
      color: #333;
    }
    h2 {
      color: #007b55;
    }
    .summary {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .summary div {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      flex: 1;
      min-width: 200px;
    }
    button {
      padding: 6px 10px;
      margin: 2px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .approve { background: #007b55; color: white; }
    .reject { background: #d00000; color: white; }
    .section {
      background: #fff;
      padding: 15px;
      margin-bottom: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    }
    .section h3 {
      color: #007b55;
      margin-bottom: 10px;
    }
    .buttons {
      margin-bottom: 20px;
    }
    .buttons button {
      background: #007b55;
      color: white;
    }
  </style>
</head>
<body><h2>Admin Dashboard</h2><div class="summary">
  <div><strong>Total Paid Deposits:</strong> UGX <span id="totalDeposits">0</span></div>
  <div><strong>Total Paid Withdrawals:</strong> UGX <span id="totalWithdrawals">0</span></div>
  <div><strong>Company Profit:</strong> UGX <span id="profit">0</span></div>
</div><div class="buttons">
  <button onclick="location.href='users.html'">Users</button>
  <button onclick="location.href='earnings.html'">Earnings</button>


<button onclick="window.location.href='adminspin.html'" style="
  background-color: #e67e22;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  font-size: 16px;
  cursor: pointer;
">
  Spin Page
</button>
<button onclick="window.location.href='allreferrals.html'" style="
  background-color: #d35400;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
">
   Referrals
</button>
<button onclick="window.location.href='deposits.html'" style="
  background-color: #2ecc71;
  color: white;
  padding: 10px 20px;
  font-size: 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
">
  Deposits
</button>

<button onclick="window.location.href='withdrawals.html'" style="
  padding: 8px 16px;
  font-size: 14px;
  background-color: #2a8c4a;
  color: white;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
">
 Withdrawals
</button>


<button onclick="window.location.href='perday.html'" style="
  padding: 12px 24px;
  font-size: 16px;
  background-color: #2a8c4a;
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 2px 5px rgba(0,0,0,0.15);
">
  Daily Summary
</button>

</div><div class="section">
  <h3>Pending Deposits</h3>
  <div id="pendingDeposits"></div>
</div><div class="section">
  <h3>Pending Withdrawals</h3>
  <div id="pendingWithdrawals"></div>
</div>



<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDIP5I-yG0skjsva9B3p-pMshPuq4odFU8",
    authDomain: "cashprint-c5e72.firebaseapp.com",
    projectId: "cashprint-c5e72",
    storageBucket: "cashprint-c5e72.appspot.com",
    messagingSenderId: "613734624925",
    appId: "1:613734624925:web:d6bc8a18b3b6cb3a31ae74"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  async function loadDashboard() {
    let totalDeposits = 0;
    let totalWithdrawals = 0;

    const depositsSnap = await db.collection("deposits").where("status", "==", "approved").get();
    depositsSnap.forEach(doc => totalDeposits += doc.data().amount);

    const withdrawalsSnap = await db.collection("withdrawals").where("status", "==", "paid").get();
    withdrawalsSnap.forEach(doc => totalWithdrawals += doc.data().amount);

    document.getElementById("totalDeposits").textContent = totalDeposits.toLocaleString();
    document.getElementById("totalWithdrawals").textContent = totalWithdrawals.toLocaleString();
    document.getElementById("profit").textContent = (totalDeposits - totalWithdrawals).toLocaleString();
  }

  async function loadPending() {
    const pendingDeposits = document.getElementById("pendingDeposits");
    const pendingWithdrawals = document.getElementById("pendingWithdrawals");

    // Users map
    const usersMap = {};
    const usersSnap = await db.collection("users").get();
    usersSnap.forEach(doc => {
      usersMap[doc.id] = doc.data();
    });

    // Earnings map
    const earningsMap = {};
    const earningsSnap = await db.collection("earnings").get();
    earningsSnap.forEach(doc => {
      const e = doc.data();
      if (!earningsMap[e.userId]) earningsMap[e.userId] = 0;
      earningsMap[e.userId] += e.amount || 0;
    });

    // Load pending deposits
    const depositsSnap = await db.collection("deposits").where("status", "==", "pending").get();
    depositsSnap.forEach(doc => {
      const d = doc.data();
      pendingDeposits.innerHTML += `
        <div><strong>${d.senderName}</strong> (${d.senderPhone}) - UGX ${d.amount}
          <button class="approve" onclick="approveDeposit('${doc.id}', ${d.amount}, '${d.userId}')">Approve</button>
          <button class="reject" onclick="rejectDeposit('${doc.id}')">Reject</button>
        </div>`;
    });

    // Load pending withdrawals with full details
    const withdrawSnap = await db.collection("withdrawals").where("status", "==", "pending").get();
    withdrawSnap.forEach(doc => {
      const d = doc.data();
      const user = usersMap[d.userId] || {};
      const userPhone = user.phone || "Unknown";
      const userName = user.name || "Unknown";
      const invested = earningsMap[d.userId] || 0;
      const time = d.timestamp?.toDate().toLocaleString() || 'No time';

      pendingWithdrawals.innerHTML += `
        <div style="margin-bottom: 10px; padding: 10px; background: #fff; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1);">
          <div><strong>Owner Name:</strong> ${userName}</div>
          <div><strong>Owner Phone (Users):</strong> ${userPhone}</div>
          <div><strong>Phone (Withdrawals):</strong> ${d.phone}</div>
          <div><strong>Name (Withdrawals):</strong> ${d.name}</div>
          <div><strong>Status:</strong> ${d.status}</div>
          <div><strong>Amount:</strong> ${d.amount?.toLocaleString()} UGX</div>
          <div><strong>Time:</strong> ${time}</div>
          <div><strong>Earnings Document:</strong> ${invested > 0 ? 'Yes' : 'No'} (${invested.toLocaleString()} UGX invested)</div>
          <button class="approve" onclick="approveWithdrawal('${doc.id}')">Approve</button>
          <button class="reject" onclick="rejectWithdrawal('${doc.id}')">Reject</button>
        </div>`;
    });
  }

  async function approveDeposit(id, amount, userId) {
    await db.collection("deposits").doc(id).update({ status: "approved" });
    await db.collection("users").doc(userId).update({
      accountBalance: firebase.firestore.FieldValue.increment(amount)
    });
    alert("Deposit approved and balance updated.");
    location.reload();
  }

  async function rejectDeposit(id) {
    await db.collection("deposits").doc(id).update({ status: "rejected" });
    alert("Deposit rejected.");
    location.reload();
  }

  async function approveWithdrawal(id) {
    await db.collection("withdrawals").doc(id).update({ status: "paid" });
    alert("Withdrawal approved.");
    location.reload();
  }

  async function rejectWithdrawal(id) {
    await db.collection("withdrawals").doc(id).update({ status: "rejected" });
    alert("Withdrawal rejected.");
    location.reload();
  }

  loadDashboard();
  loadPending();
</script>
</body>
</html>